{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django Schema Viewer</title>
    <link rel="stylesheet" href="{% static 'schema_viewer/css/schema-viewer.css' %}">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Schema Viewer</h1>
            </div>
            <div class="search-box">
                <input type="text" id="search" placeholder="Search models...">
            </div>
            <div class="model-list" id="model-list">
                <div class="loading">Loading schema...</div>
            </div>
        </aside>

        <main class="main">
            <div class="toolbar">
                <button id="zoom-in">Zoom In</button>
                <button id="zoom-out">Zoom Out</button>
                <button id="fit-view">Fit View</button>
                <button id="re-layout">Re-layout</button>
                <label>
                    <input type="checkbox" id="show-django" />
                    Show Django models
                </label>
            </div>
            <div class="canvas-container">
                <svg id="canvas"></svg>
                <!-- Legend -->
                <div class="legend">
                    <div class="legend-title">Relationships</div>
                    <div class="legend-item">
                        <div class="legend-line fk"></div>
                        <span>Foreign Key (many â†’ one)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line o2o"></div>
                        <span>One-to-One</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line m2m"></div>
                        <span>Many-to-Many</span>
                    </div>
                </div>
            </div>
        </main>

        <aside class="detail-panel" id="detail-panel">
            <div class="detail-header">
                <h2 id="detail-title">Model Details</h2>
                <button class="close-btn" id="close-detail">&times;</button>
            </div>
            <div id="detail-content">
                <!-- Populated by JavaScript -->
            </div>
        </aside>
    </div>

    <script src="{% static 'schema_viewer/js/layout.js' %}"></script>
    <script>
        // State
        let schema = null;
        let selectedModel = null;
        let transform = { x: 0, y: 0, scale: 1 };
        let nodePositions = new Map();
        let nodeHeights = {};
        let layoutData = null;
        let edgeRoutes = [];
        let isDragging = false;
        let dragTarget = null;
        let dragOffset = { x: 0, y: 0 };

        // DOM elements
        const modelList = document.getElementById('model-list');
        const canvas = document.getElementById('canvas');
        const detailPanel = document.getElementById('detail-panel');
        const detailTitle = document.getElementById('detail-title');
        const detailContent = document.getElementById('detail-content');
        const searchInput = document.getElementById('search');
        const showDjangoCheckbox = document.getElementById('show-django');

        // SVG marker definitions for ER notation
        // Using orient="auto" - markers align with path direction
        // Crow's foot: drawn pointing left (backward relative to path direction)
        // Double bar: drawn at the marker end
        const markerDefs = `
            <defs>
                <!-- FK markers (blue): crow's foot at source (many), double bar at target (one) -->
                <marker id="marker-many-fk" viewBox="0 0 12 12" refX="12" refY="6"
                        markerWidth="10" markerHeight="10" orient="auto">
                    <path d="M 12 6 L 0 0 M 12 6 L 0 12" stroke="#3b82f6" stroke-width="2" fill="none"/>
                </marker>
                <marker id="marker-one-fk" viewBox="0 0 10 12" refX="0" refY="6"
                        markerWidth="8" markerHeight="10" orient="auto">
                    <line x1="1" y1="0" x2="1" y2="12" stroke="#3b82f6" stroke-width="2"/>
                    <line x1="6" y1="0" x2="6" y2="12" stroke="#3b82f6" stroke-width="2"/>
                </marker>

                <!-- O2O markers (purple): single bar at source, double bar at target -->
                <marker id="marker-one-o2o-start" viewBox="0 0 10 12" refX="6" refY="6"
                        markerWidth="8" markerHeight="10" orient="auto">
                    <line x1="0" y1="0" x2="0" y2="12" stroke="#8b5cf6" stroke-width="2"/>
                </marker>
                <marker id="marker-one-o2o-end" viewBox="0 0 10 12" refX="0" refY="6"
                        markerWidth="8" markerHeight="10" orient="auto">
                    <line x1="1" y1="0" x2="1" y2="12" stroke="#8b5cf6" stroke-width="2"/>
                    <line x1="6" y1="0" x2="6" y2="12" stroke="#8b5cf6" stroke-width="2"/>
                </marker>

                <!-- M2M markers (green): crow's foot at both ends -->
                <marker id="marker-many-m2m-start" viewBox="0 0 12 12" refX="12" refY="6"
                        markerWidth="10" markerHeight="10" orient="auto">
                    <path d="M 12 6 L 0 0 M 12 6 L 0 12" stroke="#10b981" stroke-width="2" fill="none"/>
                </marker>
                <marker id="marker-many-m2m-end" viewBox="0 0 12 12" refX="0" refY="6"
                        markerWidth="10" markerHeight="10" orient="auto">
                    <path d="M 0 6 L 12 0 M 0 6 L 12 12" stroke="#10b981" stroke-width="2" fill="none"/>
                </marker>
            </defs>
        `;

        // Fetch schema data
        async function fetchSchema() {
            const excludeDjango = !showDjangoCheckbox.checked;
            const response = await fetch(`api/schema/?exclude_django=${excludeDjango}`);
            schema = await response.json();
            renderModelList();
            calculateLayout();
            renderCanvas();
        }

        // Calculate node heights based on field count
        function calculateNodeHeights() {
            nodeHeights = {};
            for (const [appLabel, appData] of Object.entries(schema.apps)) {
                for (const [modelName, model] of Object.entries(appData.models)) {
                    const key = `${appLabel}.${modelName}`;
                    const fields = (model.fields || []).slice(0, 5);
                    const hasMore = model.fields?.length > 5;
                    nodeHeights[key] = 50 + 16 + (fields.length * 28) + (hasMore ? 24 : 0);
                }
            }
        }

        // Calculate hierarchical layout
        function calculateLayout() {
            calculateNodeHeights();
            layoutData = Layout.calculateHierarchicalLayout(schema, nodeHeights);
            nodePositions = layoutData.positions;
            // Calculate edge routes
            edgeRoutes = Layout.calculateEdgeRoutes(
                nodePositions,
                layoutData.edges,
                nodeHeights,
                layoutData.nodeMap
            );
        }

        // Render the model list in sidebar
        function renderModelList() {
            const searchTerm = searchInput.value.toLowerCase();
            let html = '';

            for (const [appLabel, appData] of Object.entries(schema.apps)) {
                const models = Object.entries(appData.models).filter(([name]) =>
                    name.toLowerCase().includes(searchTerm)
                );

                if (models.length === 0) continue;

                html += `
                    <div class="app-group">
                        <div class="app-header" data-app="${appLabel}">
                            <span class="arrow">â–¼</span>
                            ${appData.verbose_name}
                        </div>
                        <div class="app-models">
                            ${models.map(([modelName, model]) => `
                                <div class="model-item" data-app="${appLabel}" data-model="${modelName}">
                                    ${model.verbose_name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            modelList.innerHTML = html || '<div class="loading">No models found</div>';

            // Add event listeners
            modelList.querySelectorAll('.app-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('collapsed');
                    header.nextElementSibling.style.display =
                        header.classList.contains('collapsed') ? 'none' : 'block';
                });
            });

            modelList.querySelectorAll('.model-item').forEach(item => {
                item.addEventListener('click', () => {
                    selectModel(item.dataset.app, item.dataset.model);
                });
            });
        }

        // Render the canvas with nodes and relationships
        function renderCanvas() {
            let nodesHtml = '';
            let edgesHtml = '';

            // Draw edges using precalculated routes
            for (const route of edgeRoutes) {
                const { edge, points } = route;
                const rel = edge.rel;
                const relClass = rel.type.replace('_', '-');
                const pathD = Layout.pathToSvgRounded(points);

                // Determine markers based on relationship type
                let startMarker = '';
                let endMarker = '';

                if (rel.type === 'foreign_key') {
                    startMarker = 'url(#marker-many-fk)';
                    endMarker = 'url(#marker-one-fk)';
                } else if (rel.type === 'one_to_one') {
                    startMarker = 'url(#marker-one-o2o-start)';
                    endMarker = 'url(#marker-one-o2o-end)';
                } else if (rel.type === 'many_to_many') {
                    startMarker = 'url(#marker-many-m2m-start)';
                    endMarker = 'url(#marker-many-m2m-end)';
                }

                edgesHtml += `
                    <path class="relationship-line ${relClass}"
                          d="${pathD}"
                          marker-start="${startMarker}"
                          marker-end="${endMarker}"
                          data-source="${edge.source}"
                          data-target="${edge.target}"
                          data-rel-name="${rel.name}"
                          data-rel-type="${rel.type}">
                        <title>${rel.name}: ${edge.source} â†’ ${edge.target}</title>
                    </path>
                `;
            }

            // Also draw self-referential relationships (not in layoutData.edges)
            for (const [appLabel, appData] of Object.entries(schema.apps)) {
                for (const [modelName, model] of Object.entries(appData.models)) {
                    const sourceKey = `${appLabel}.${modelName}`;
                    const sourcePos = nodePositions.get(sourceKey);
                    if (!sourcePos) continue;

                    for (const rel of model.relationships || []) {
                        if (rel.direction !== 'forward') continue;
                        const targetKey = `${rel.target_app}.${rel.target_model}`;

                        // Only handle self-referential here
                        if (targetKey !== sourceKey) continue;

                        const relClass = rel.type.replace('_', '-');
                        const height = nodeHeights[sourceKey] || 180;

                        // Draw a loop on the right side
                        const loopSize = 40;
                        const startX = sourcePos.x + 220;
                        const startY = sourcePos.y + height / 3;
                        const endY = sourcePos.y + height * 2 / 3;

                        const pathD = `M ${startX} ${startY} ` +
                            `L ${startX + loopSize} ${startY} ` +
                            `L ${startX + loopSize} ${endY} ` +
                            `L ${startX} ${endY}`;

                        edgesHtml += `
                            <path class="relationship-line ${relClass}"
                                  d="${pathD}"
                                  marker-end="url(#marker-one-fk)"
                                  data-source="${sourceKey}"
                                  data-target="${targetKey}"
                                  data-rel-name="${rel.name}"
                                  data-rel-type="${rel.type}">
                                <title>${rel.name}: ${sourceKey} â†’ ${targetKey} (self)</title>
                            </path>
                        `;
                    }
                }
            }

            // Draw nodes
            for (const [appLabel, appData] of Object.entries(schema.apps)) {
                for (const [modelName, model] of Object.entries(appData.models)) {
                    const key = `${appLabel}.${modelName}`;
                    const pos = nodePositions.get(key);
                    if (!pos) continue;

                    const isSelected = selectedModel === key;
                    const height = nodeHeights[key] || 180;

                    const fields = (model.fields || []).slice(0, 5);
                    const fieldsHtml = fields.map(f => {
                        const isPk = f.primary_key;
                        const isFk = model.relationships?.some(r =>
                            r.direction === 'forward' && r.name === f.name.replace('_id', '')
                        );
                        const fieldClass = isPk ? 'pk' : (isFk ? 'fk' : '');
                        const icon = isPk ? 'ðŸ”‘ ' : (isFk ? 'ðŸ”— ' : '');
                        return `
                            <div class="model-node-field ${fieldClass}">
                                <span>${icon}${f.name}</span>
                                <span class="model-node-field-type">${f.type}</span>
                            </div>
                        `;
                    }).join('');

                    nodesHtml += `
                        <foreignObject x="${pos.x}" y="${pos.y}" width="220" height="${height}" class="node-wrapper" data-key="${key}">
                            <div xmlns="http://www.w3.org/1999/xhtml"
                                 class="model-node ${isSelected ? 'selected' : ''}"
                                 data-app="${appLabel}"
                                 data-model="${modelName}">
                                <div class="model-node-header">
                                    ${model.verbose_name}
                                    <div class="model-node-app">${appData.verbose_name}</div>
                                </div>
                                <div class="model-node-fields">
                                    ${fieldsHtml}
                                    ${model.fields?.length > 5 ? `<div style="color: #64748b; padding-top: 4px;">+${model.fields.length - 5} more fields</div>` : ''}
                                </div>
                            </div>
                        </foreignObject>
                    `;
                }
            }

            canvas.innerHTML = `
                ${markerDefs}
                <g transform="translate(${transform.x}, ${transform.y}) scale(${transform.scale})">
                    ${edgesHtml}
                    ${nodesHtml}
                </g>
            `;

            // Add node event listeners
            canvas.querySelectorAll('.model-node').forEach(node => {
                node.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectModel(node.dataset.app, node.dataset.model);
                });

                node.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    dragTarget = `${node.dataset.app}.${node.dataset.model}`;
                    const pos = nodePositions.get(dragTarget);
                    dragOffset = {
                        x: (e.clientX - transform.x) / transform.scale - pos.x,
                        y: (e.clientY - transform.y) / transform.scale - pos.y
                    };
                });
            });
        }

        // Select a model and show details
        async function selectModel(appLabel, modelName) {
            selectedModel = `${appLabel}.${modelName}`;

            // Update UI
            modelList.querySelectorAll('.model-item').forEach(item => {
                item.classList.toggle('selected',
                    item.dataset.app === appLabel && item.dataset.model === modelName);
            });

            // Fetch and show details
            const response = await fetch(`api/model/${appLabel}/${modelName}/`);
            const model = await response.json();

            detailTitle.textContent = model.verbose_name;

            let html = `
                <div class="detail-section">
                    <h3>Info</h3>
                    <div class="field-item">
                        <div class="field-name">Database Table</div>
                        <div class="field-type">${model.db_table}</div>
                    </div>
                    ${model.proxy ? '<div class="badge">Proxy Model</div>' : ''}
                    ${model.abstract ? '<div class="badge">Abstract</div>' : ''}
                </div>

                <div class="detail-section">
                    <h3>Fields (${model.fields?.length || 0})</h3>
                    ${(model.fields || []).map(f => `
                        <div class="field-item">
                            <div class="field-name">${f.name}</div>
                            <div class="field-type">${f.type}${f.max_length ? `(${f.max_length})` : ''}</div>
                            <div class="field-badges">
                                ${f.primary_key ? '<span class="badge primary">PK</span>' : ''}
                                ${f.unique ? '<span class="badge unique">Unique</span>' : ''}
                                ${f.null ? '<span class="badge nullable">Nullable</span>' : ''}
                                ${f.db_index ? '<span class="badge indexed">Indexed</span>' : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            if (model.relationships?.length) {
                html += `
                    <div class="detail-section">
                        <h3>Relationships (${model.relationships.length})</h3>
                        ${model.relationships.map(r => `
                            <div class="field-item">
                                <div class="field-name">${r.name}</div>
                                <div class="field-type">${r.type} â†’ ${r.target_app}.${r.target_model}</div>
                                <div class="field-badges">
                                    <span class="badge">${r.direction}</span>
                                    ${r.on_delete ? `<span class="badge">${r.on_delete}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            detailContent.innerHTML = html;
            detailPanel.classList.add('visible');

            renderCanvas();
        }

        // Event listeners
        document.getElementById('close-detail').addEventListener('click', () => {
            detailPanel.classList.remove('visible');
            selectedModel = null;
            renderCanvas();
        });

        searchInput.addEventListener('input', renderModelList);

        showDjangoCheckbox.addEventListener('change', fetchSchema);

        document.getElementById('zoom-in').addEventListener('click', () => {
            transform.scale = Math.min(transform.scale * 1.2, 3);
            renderCanvas();
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            transform.scale = Math.max(transform.scale / 1.2, 0.3);
            renderCanvas();
        });

        document.getElementById('fit-view').addEventListener('click', () => {
            transform = { x: 0, y: 0, scale: 1 };
            renderCanvas();
        });

        document.getElementById('re-layout').addEventListener('click', () => {
            calculateLayout();
            renderCanvas();
        });

        // Canvas pan
        let isPanning = false;
        let panStart = { x: 0, y: 0 };

        canvas.addEventListener('mousedown', (e) => {
            if (e.target === canvas || e.target.tagName === 'svg' || e.target.tagName === 'g') {
                isPanning = true;
                panStart = { x: e.clientX - transform.x, y: e.clientY - transform.y };
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (isPanning) {
                transform.x = e.clientX - panStart.x;
                transform.y = e.clientY - panStart.y;
                renderCanvas();
            } else if (isDragging && dragTarget) {
                nodePositions.set(dragTarget, {
                    x: (e.clientX - transform.x) / transform.scale - dragOffset.x,
                    y: (e.clientY - transform.y) / transform.scale - dragOffset.y
                });
                // Recalculate edge routes after moving a node
                edgeRoutes = Layout.calculateEdgeRoutes(
                    nodePositions,
                    layoutData.edges,
                    nodeHeights,
                    layoutData.nodeMap
                );
                renderCanvas();
            }
        });

        window.addEventListener('mouseup', () => {
            isPanning = false;
            isDragging = false;
            dragTarget = null;
        });

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            transform.scale = Math.max(0.3, Math.min(3, transform.scale * delta));
            renderCanvas();
        });

        // Initial load
        fetchSchema();
    </script>
</body>
</html>
